import { exec } from 'node:child_process';
import { CONSTANTS } from '../shared/constants';
import type { Finding } from '../types';

interface VulnerabilityEntry {
	module_name?: string;
	name?: string;
	package_name?: string;
	title?: string;
	severity?: string;
	metadata?: {
		severity?: string;
	};
	findings?: Array<{
		package?: string;
	}>;
}

interface AuditJson {
	vulnerabilities?: Record<string, VulnerabilityEntry>;
	advisories?: Record<string, VulnerabilityEntry>;
}

function isAuditJson(data: unknown): data is AuditJson {
	return (
		typeof data === 'object' &&
		data !== null &&
		('vulnerabilities' in data || 'advisories' in data)
	);
}

export async function vulnerabilityAnalyzer(cwd: string): Promise<Finding[]> {
	return new Promise((resolve) => {
		exec(
			'npm audit --json',
			{ cwd, maxBuffer: CONSTANTS.EXEC_MAX_BUFFER },
			(err, stdout) => {
				try {
					if (!stdout) {
						return resolve([]);
					}

					const json: unknown = JSON.parse(stdout);

					if (!isAuditJson(json)) {
						console.warn('Invalid npm audit JSON format');
						return resolve([]);
					}

					const advisories = json.vulnerabilities || json.advisories || {};
					const results: Finding[] = [];

					for (const key of Object.keys(advisories)) {
						const entry = advisories[key];
						const moduleName =
							entry.module_name ||
							entry.name ||
							entry.package_name ||
							entry.findings?.[0]?.package;

						const title = entry.title || 'Vulnerabilidad detectada';
						const severity =
							entry.severity || entry.metadata?.severity || 'moderate';

						results.push({
							type:
								severity === 'high' || severity === 'critical'
									? 'error'
									: 'warning',
							message: `${title} (sev: ${severity})`,
							dependency: moduleName,
							tags: ['security'],
						});
					}

					resolve(results);
				} catch (error) {
					const errorMessage =
						error instanceof Error ? error.message : 'Unknown error';
					console.error(
						`Error parsing npm audit output: ${errorMessage}`,
						error,
					);
					resolve([]);
				}
			},
		);
	});
}
